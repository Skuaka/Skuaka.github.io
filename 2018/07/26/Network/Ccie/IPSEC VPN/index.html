<!DOCTYPE html>
<html lang="zh-cmn-Hans">
  <head><meta name="generator" content="Hexo 3.8.0">
  <meta charset="UTF-8">
  <meta name="viewport" content="viewport-fit=cover, width=device-width, initial-scale=1, maximum-scale=1, minimum-scale=1, user-scalable=no">
  <meta http-equiv="”Cache-Control”" content="no-transform">
  <meta http-equiv="Cache-Control" content="no-siteapp">
  <meta http-equiv="X-UA-Compatible" content="ie=edge">
  
  <title>CCIE IPSEC VPN | Skuaka</title>
  <link rel="icon" type="image/png" sizes="32x32" href>
  



<link rel="stylesheet" href="/./vendor.ec1199.css"><link rel="stylesheet" href="/./app.5ed5af.css">


</head>
  <body>
    <header class="main-header">
  <div class="container">
    <a href="/" " class="logo">
      <img src="logo.jpg" alt="Skuaka" class="logo-img">
    </a>
    <span class="nav-separator"></span>
    <form action="//google.com/search" method="get" accept-charset="UTF-8" class="search-form"><input type="search" name="q" class="search-form-input" placeholder="搜索文章"><input type="hidden" name="sitesearch" value="http://yoursite.com"></form>
    <a href="javascript:void(0);" class="nav-icon">
      <i class="fas fa-bars"></i>
    </a>
    <nav class="main-nav">
      <ul class="nav-list">
        
          <li class="nav-link ">
            <a href="/">首页</a>
          </li>
        
          <li class="nav-link ">
            <a href="/archives/">归档</a>
          </li>
        
          <li class="nav-link ">
            <a href="/categories">分类</a>
          </li>
        
          <li class="nav-link ">
            <a href="/about.html">关于</a>
          </li>
        
      </ul>
    </nav>
  </div>
</header>
    <div class="page--article">
  
    <div class="toc-container">
      <ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#IPSEC-VPN"><span class="toc-number">1.</span> <span class="toc-text">IPSEC VPN</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#数据在公共网络上面临的风险"><span class="toc-number">1.1.</span> <span class="toc-text">数据在公共网络上面临的风险</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#IPSEC-VPN-解决的问题"><span class="toc-number">1.2.</span> <span class="toc-text">IPSEC VPN 解决的问题</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#KEY：密匙"><span class="toc-number">1.3.</span> <span class="toc-text">KEY：密匙</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#对称密钥、非对称密钥"><span class="toc-number">1.3.1.</span> <span class="toc-text">对称密钥、非对称密钥</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#IPSEC-VPN-的加密密钥"><span class="toc-number">1.3.2.</span> <span class="toc-text">IPSEC VPN 的加密密钥</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#密钥产生过程和共享方法"><span class="toc-number">1.3.3.</span> <span class="toc-text">密钥产生过程和共享方法</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#IPSEC-VPN-的关键组件"><span class="toc-number">1.4.</span> <span class="toc-text">IPSEC VPN 的关键组件</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#IPSEC-VPN-配置流程"><span class="toc-number">1.5.</span> <span class="toc-text">IPSEC VPN 配置流程</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#ESP-和-AH"><span class="toc-number">1.6.</span> <span class="toc-text">ESP 和 AH</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#IPSEC-VPN-的模式"><span class="toc-number">1.7.</span> <span class="toc-text">IPSEC VPN 的模式</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#NAT-对-IPSEC-VPN-的影响"><span class="toc-number">1.8.</span> <span class="toc-text">NAT 对 IPSEC VPN 的影响</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#结束"><span class="toc-number">2.</span> <span class="toc-text">结束</span></a></li></ol>
      <div class="toc-tip">Table of Contents ▼</div>
    </div>
  


  <div class="container">
    <article>
      <h1>CCIE IPSEC VPN</h1>
      <h2 id="IPSEC-VPN"><a href="#IPSEC-VPN" class="headerlink" title="IPSEC VPN"></a>IPSEC VPN</h2><p>Ip security vpn，是一个工作在网络层的 VPN 技术。</p>
<h3 id="数据在公共网络上面临的风险"><a href="#数据在公共网络上面临的风险" class="headerlink" title="数据在公共网络上面临的风险"></a>数据在公共网络上面临的风险</h3><ol>
<li>不加密，明文传递</li>
<li>没有完整性保护，数据容易被篡改</li>
<li>没有对等体认证，容易受到中间人攻击</li>
<li>抵赖</li>
</ol>
<h3 id="IPSEC-VPN-解决的问题"><a href="#IPSEC-VPN-解决的问题" class="headerlink" title="IPSEC VPN 解决的问题"></a>IPSEC VPN 解决的问题</h3><ol>
<li><p>对等体认证，数据发送之前必须经过认证且通过</p>
<p>口令认证、数字证书（计算机世界的身份证）、加密随机数</p>
</li>
<li><p>数据加密</p>
<p>des、3des、aes</p>
</li>
<li><p>数据完整性保护</p>
<p>HMAC：哈希消息认证码</p>
</li>
<li><p>数字签名，防抵赖</p>
<p>DSA（RSA 公司开发）</p>
</li>
</ol>
<h3 id="KEY：密匙"><a href="#KEY：密匙" class="headerlink" title="KEY：密匙"></a>KEY：密匙</h3><p>KEY 是一个工具，可以参与算法作为变量出现，也可以参与认证作为口令出现。</p>
<h4 id="对称密钥、非对称密钥"><a href="#对称密钥、非对称密钥" class="headerlink" title="对称密钥、非对称密钥"></a>对称密钥、非对称密钥</h4><p>（加密算法中的 KEY 的理解）</p>
<ol>
<li><p>对等密钥及对称密钥加密算法</p>
<p>加密解密密钥是同一把</p>
<p><strong>坏处</strong>：不够安全、Key 的共享存在风险</p>
<p><strong>好处</strong>：简单高效</p>
</li>
<li><p>非对称密钥及非对称密钥算法</p>
<p>非对称密钥是一对KEY，公钥和密钥。</p>
<p>公钥最后会公开，密钥不公开。</p>
<p>公钥加密的数据，只有私钥可以解开。</p>
<p>私钥加密的数据，只有公钥可以解开。</p>
<p><strong>坏处</strong>：复杂，数据会变庞大</p>
<p><strong>好处</strong>：安全可靠</p>
</li>
</ol>
<h4 id="IPSEC-VPN-的加密密钥"><a href="#IPSEC-VPN-的加密密钥" class="headerlink" title="IPSEC VPN 的加密密钥"></a>IPSEC VPN 的加密密钥</h4><p>非对称密钥共享是用对称密钥及算法保护</p>
<p>数据本身是用非对称密钥及算法保护</p>
<h4 id="密钥产生过程和共享方法"><a href="#密钥产生过程和共享方法" class="headerlink" title="密钥产生过程和共享方法"></a>密钥产生过程和共享方法</h4><p>DH 算法负责产生密钥和共享密钥</p>
<h3 id="IPSEC-VPN-的关键组件"><a href="#IPSEC-VPN-的关键组件" class="headerlink" title="IPSEC VPN 的关键组件"></a>IPSEC VPN 的关键组件</h3><p>ISAKMP：互联网安全关联密钥管理协议</p>
<ul>
<li><p>ISA：通讯双方建立了安全连接就叫做一个 SA 成功了。</p>
<p>IPSEC VPN 的 SA 有两个：一个是保护 VPN 的，一个是保护数据的。</p>
</li>
<li><p>KMP：KMP 是通过 IKE（互联网密钥交换机制）完成的，IKE 专门负责产生密钥，共享密钥。</p>
<p>IKE 分两个阶段：阶段1产生和共享VPN自身所需的密钥，阶段2利用阶段1的密钥算出新密钥，用于保护用户数据。</p>
</li>
</ul>
<h3 id="IPSEC-VPN-配置流程"><a href="#IPSEC-VPN-配置流程" class="headerlink" title="IPSEC VPN 配置流程"></a>IPSEC VPN 配置流程</h3><p>IOS 中必须带 K9 字样，才支持加密算法： <code>show version</code></p>
<p>步骤1：开启 ISAKMP</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">crypto isakmp enable</span><br></pre></td></tr></table></figure>
<p>步骤2：配置 IPSEC VPN 策略1</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">crypto policy &lt;seq&gt;</span><br><span class="line">authentication &lt;pre-share/rsa&gt; //认证方式</span><br><span class="line">hash &lt;md5/sha&gt; //定义完整性保护算法</span><br><span class="line">group &lt;1/2/5&gt; //定义 DH 算法等级</span><br><span class="line">encryption &lt;des/3des/aes&gt; //定义加密算法</span><br><span class="line">lifetime &lt;xxs&gt; //定义生命周期</span><br></pre></td></tr></table></figure>
<p>步骤3：配置 IPSEC VPN peer</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">crypto isakmp key 0 &lt;口令&gt; address &lt;peer-address&gt; //对等体地址必须可达</span><br></pre></td></tr></table></figure>
<p>步骤4：配置感兴趣流，告诉 VPN 保护什么流量</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">access-list permit ip &lt;源&gt; &lt;目的&gt;</span><br></pre></td></tr></table></figure>
<p>步骤5：配置转换集定义数据加密方式</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">crypto ipsec trans &lt;name&gt; &lt;加密算法&gt; &lt;完整性保护算法&gt;</span><br></pre></td></tr></table></figure>
<p>步骤6：定义加密映射，将数据加密转换集、对等体、感兴趣流绑定</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">crypto map &lt;名字&gt; &lt;序列号&gt; ipsec-isakmp</span><br><span class="line">set peer &lt;peer-address&gt; //设置对等体地址</span><br><span class="line">match address &lt;acl-id&gt; //匹配感兴趣流</span><br><span class="line">trans-set &lt;转换集名称&gt; //设置转化集</span><br></pre></td></tr></table></figure>
<p>步骤7：应用加密映射（只能用在发送流量的接口）</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">interface &lt;intf-id&gt;</span><br><span class="line">crypto map &lt;name&gt;</span><br></pre></td></tr></table></figure>
<p>步骤8：查看命令</p>
<p>查看数据是否被加密<code>show crypto engine connections active</code></p>
<h3 id="ESP-和-AH"><a href="#ESP-和-AH" class="headerlink" title="ESP 和 AH"></a>ESP 和 AH</h3><p>ESP 和 AH 都是 VPN 头部信息的缩写</p>
<p>帧头、包头、段头、数据、帧尾</p>
<p>数据经历 VPN 保护后变化成如下：</p>
<p>帧头、VPN 头、包头、段头、数据、帧尾</p>
<p>VPN 头就分两种：</p>
<ol>
<li><p>ESP：封装安全静荷</p>
<p>该头负责保护数据的完整性，同时加密数据</p>
</li>
<li><p>AH：认证头</p>
<p>该头只负责保护数据完整性，不加密数据</p>
</li>
</ol>
<h3 id="IPSEC-VPN-的模式"><a href="#IPSEC-VPN-的模式" class="headerlink" title="IPSEC VPN 的模式"></a>IPSEC VPN 的模式</h3><ol>
<li><p>隧道模式（tunnel）</p>
<p>VPN 网关通过一个隧道模式的 VPN 连接，保护身后所有的通讯数据。</p>
</li>
<li><p>传输模式（transport）</p>
<p>通讯双方自身建立 VPN 连接，保护通讯数据。</p>
</li>
</ol>
<p><strong>区别</strong>：</p>
<p>隧道模式的新包头，目的 IP 和源 IP 是 VPN 的对等体地址。</p>
<p>传输模式的新包头，目的 IP 和源 IP 复制了原有的 IP 地址。</p>
<h3 id="NAT-对-IPSEC-VPN-的影响"><a href="#NAT-对-IPSEC-VPN-的影响" class="headerlink" title="NAT 对 IPSEC VPN 的影响"></a>NAT 对 IPSEC VPN 的影响</h3><p>VPN 流量几乎永远是先被 inside 接口接收，所以 NAT 会直接修改 IP 包头，导致 VPN 无法识别感兴趣流。</p>
<p>解决方案</p>
<p>NAT 配置的时候不要使用标准 ACL，用扩展 ACL，书写方法如下：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">access-list 100 deny ip 10.5.5.0 0.0.0.255 10.7.7.0 0.0.0.255</span><br><span class="line">access-list 100 permit ip 10.5.5.0 0.0.0.255 any</span><br><span class="line">ip nat inside source list 100 interface e0/2 overload</span><br></pre></td></tr></table></figure>
<h2 id="结束"><a href="#结束" class="headerlink" title="结束"></a>结束</h2>
  </article>
    
  </div>
</div>

    <footer class="main-footer">
  <div class="container">
    © 2018 
  </div>
</footer>
    



<script src="/./runtime.32f029.js"></script><script src="/./vendor.ec1199.js"></script><script src="/./app.5ed5af.js"></script>


  </body>
</html>
